{% load static %}
{% block content %}
{% include 'header.html' %}

<!-- ***** Header Area End ***** -->

<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <span class="breadcrumb"><a href="http://127.0.0.1:8000/index">Home</a> / <a href="http://127.0.0.1:8000/view_emergency">View Emergency</a> / Respond to Emergency</span>
        <h3>Respond to Emergency #{{ emergency.id }}</h3>
      </div>
    </div>
  </div>
</div>

<div class="contact-page section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h4>Emergency Details</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Type:</strong> {{ emergency.get_emergency_type_display }}</p>
                <p><strong>Location:</strong> {{ emergency.location }}</p>
                <p><strong>Contact:</strong> {{ emergency.contact_number }}</p>
                <p><strong>Status:</strong>
                  <span class="badge badge-{% if emergency.status == 'pending' %}warning{% elif emergency.status == 'responding' %}info{% elif emergency.status == 'resolved' %}success{% else %}secondary{% endif %}">
                    {{ emergency.get_status_display }}
                  </span>
                </p>
              </div>
              <div class="col-md-6">
                <p><strong>Reported By:</strong> {{ emergency.reporter.name }} ({{ emergency.reporter.rank }})</p>
                <p><strong>Reported At:</strong> {{ emergency.reported_at|date:"M d, Y H:i" }}</p>
                {% if emergency.medical_help_needed %}
                <p><strong>Medical Help Needed:</strong> <span class="text-danger">Yes</span></p>
                {% if emergency.medical_details %}
                <p><strong>Medical Details:</strong> {{ emergency.medical_details }}</p>
                {% endif %}
                {% endif %}
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Description:</strong></p>
                <p>{{ emergency.description }}</p>
              </div>
            </div>

            {% if emergency.responded_by %}
            <div class="row mt-3">
              <div class="col-12">
                <h5>Police Response</h5>
                <p><strong>Responded By:</strong> {{ emergency.responded_by.name }}</p>
                {% if emergency.response_notes %}
                <p><strong>Response Notes:</strong> {{ emergency.response_notes }}</p>
                {% endif %}
              </div>
            </div>
            {% endif %}

            {% if emergency.medical_staff_assigned %}
            <div class="row mt-3">
              <div class="col-12">
                <h5>Medical Response</h5>
                <p><strong>Assigned Medical Staff:</strong> Dr. {{ emergency.medical_staff_assigned.name }} ({{ emergency.medical_staff_assigned.specialization }})</p>
                {% if emergency.medical_response_notes %}
                <p><strong>Medical Response Notes:</strong> {{ emergency.medical_response_notes }}</p>
                {% endif %}
                {% if emergency.medical_response_at %}
                <p><strong>Response Time:</strong> {{ emergency.medical_response_at|date:"M d, Y H:i" }}</p>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h4>Response Actions</h4>
          </div>
          <div class="card-body">
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            {% endif %}

            {% if request.session.police_id %}
              {% if emergency.status == 'responding' %}
                <form method="post">
                  {% csrf_token %}
                  <div class="form-group">
                    <label for="notes">Resolution Notes</label>
                    <textarea class="form-control" name="notes" rows="3" placeholder="Enter resolution details..."></textarea>
                  </div>
                  <button type="submit" name="action" value="resolve" class="btn btn-success btn-block">Mark as Resolved</button>
                  <button type="submit" name="action" value="cancel" class="btn btn-danger btn-block">Cancel Emergency</button>
                </form>
              {% else %}
                <p class="text-muted">Medical staff are handling the initial response for this emergency.</p>
              {% endif %}

            {% elif request.session.medical_staff_id %}
              {% if emergency.status == 'pending' and emergency.medical_help_needed %}
                <form method="post">
                  {% csrf_token %}
                  <div class="form-group">
                    <label for="notes">Initial Medical Assessment</label>
                    <textarea class="form-control" name="notes" rows="3" placeholder="Enter your initial medical assessment..."></textarea>
                  </div>
                  <button type="submit" name="action" value="respond" class="btn btn-primary btn-block">Start Responding</button>
                  <button type="submit" name="action" value="assign_medical" class="btn btn-info btn-block">Assign for Later</button>
                </form>
              {% elif emergency.medical_staff_assigned.id == request.session.medical_staff_id and emergency.status == 'responding' %}
                <form method="post">
                  {% csrf_token %}
                  <div class="form-group">
                    <label for="notes">Medical Resolution Notes</label>
                    <textarea class="form-control" name="notes" rows="3" placeholder="Enter medical resolution details..."></textarea>
                  </div>
                  <button type="submit" name="action" value="medical_resolve" class="btn btn-success btn-block">Mark Medical Emergency Resolved</button>
                </form>
              {% else %}
                {% if emergency.medical_staff_assigned %}
                  <p class="text-muted">This medical emergency is assigned to Dr. {{ emergency.medical_staff_assigned.name }}.</p>
                {% else %}
                  <p class="text-muted">No medical assistance required or already assigned.</p>
                {% endif %}
              {% endif %}
            {% endif %}

            <a href="{% url 'view_emergency' %}" class="btn btn-secondary btn-block mt-2">Back to Emergency List</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'footer.html' %}

<!-- Bootstrap core JavaScript -->
<script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<!-- Additional Scripts -->
<script src="{% static 'assets/js/custom.js' %}"></script>
<script src="{% static 'assets/js/owl.js' %}"></script>
<script src="{% static 'assets/js/slick.js' %}"></script>
<script src="{% static 'assets/js/isotope.js' %}"></script>
<script src="{% static 'assets/js/accordions.js' %}"></script>

{% endblock %}